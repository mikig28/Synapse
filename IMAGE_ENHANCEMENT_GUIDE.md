# Image Enhancement for Agent Reports

This guide covers the new AI-powered image enhancement system that automatically adds relevant images to news items generated by your agents.

## üéØ Overview

The image enhancement system provides:
- **Automatic image generation** for all new news items
- **Content-aware relevance**: Analyzes news content to generate highly relevant visuals
- **Smart fallback system**: Unsplash photos ‚Üí FLUX AI generation
- **Topic detection**: Automatically categorizes content (tech, business, science, etc.)
- **Intelligent caching** to avoid duplicate API calls
- **Cost optimization** with free Unsplash API priority
- **Visual attribution** for all image sources

## üé® Content Relevance System

### **How Images Stay Relevant**

The system uses advanced prompt engineering to ensure images match your content:

1. **Content Analysis**: Extracts key concepts from news titles and descriptions
2. **Topic Detection**: Identifies content categories (technology, business, science, etc.)
3. **Visual Concept Mapping**: Translates abstract concepts into visual elements
4. **Style Enhancement**: Applies appropriate visual styles for each content type

### **Examples of Relevance**

| News Content | Generated Image Style |
|--------------|----------------------|
| "Tesla announces battery breakthrough" | Electric vehicle technology, automotive innovation |
| "AI startup raises $50M funding" | Technology, artificial intelligence, business meeting |
| "Climate summit reaches agreement" | Environmental themes, sustainability, global cooperation |
| "New cancer treatment discovered" | Medical research, laboratory, healthcare imagery |
| "SpaceX launches Mars mission" | Space technology, rocket launch, cosmic imagery |

### **Topic-Specific Styling**

- **Technology**: Modern tech illustrations, digital designs, innovation themes
- **Business**: Professional photography, corporate environments, financial imagery  
- **Science**: Research imagery, laboratory settings, scientific illustrations
- **Environment**: Nature photography, sustainability focus, green energy
- **Health**: Medical illustrations, healthcare settings, treatment imagery
- **Politics**: Governmental imagery, formal compositions, policy themes

## üîß Setup

### 1. Environment Variables

Add these to your `.env` file:

```bash
# Required: Replicate API for FLUX image generation
REPLICATE_API_TOKEN=your-replicate-api-token-here

# Optional: Unsplash API for free stock photos (recommended)
UNSPLASH_ACCESS_KEY=your-unsplash-access-key
```

### 2. Get API Keys

**Replicate API (Required):**
1. Go to [replicate.com](https://replicate.com)
2. Sign up and get your API token
3. Add to `.env` as `REPLICATE_API_TOKEN`

**Unsplash API (Optional but Recommended):**
1. Go to [unsplash.com/developers](https://unsplash.com/developers)
2. Create a new application
3. Get your Access Key
4. Add to `.env` as `UNSPLASH_ACCESS_KEY`

## üöÄ How It Works

### Automatic Enhancement Flow

1. **Agent creates news item** ‚Üí System extracts key topics from title/description
2. **Try Unsplash first** ‚Üí Search for relevant stock photos (free, fast)
3. **Fallback to FLUX** ‚Üí Generate AI image if no suitable photos found
4. **Cache result** ‚Üí Store in MongoDB to avoid duplicate API calls
5. **Display in UI** ‚Üí Show image with source attribution

### Image Sources

- **üì∏ Unsplash**: Free stock photos with photographer attribution
- **üé® FLUX**: AI-generated images via Replicate API
- **‚ö° Cache**: Previously generated images stored locally

## üì± Frontend Integration

### News Item Display

Images now appear in news cards with:
- **Visual indicators**: üì∏ for Unsplash, üé® for AI-generated
- **Attribution overlay**: Hover to see photographer credit
- **Fallback handling**: Graceful degradation if image fails to load

### Manual Enhancement

Users can manually enhance news items via:
- Individual item enhancement: `POST /api/news/:id/enhance-image`
- Bulk recent enhancement: `POST /api/news/enhance/recent`
- Statistics dashboard: `GET /api/news/images/stats`

## üõ†Ô∏è API Endpoints

### Image Enhancement

```typescript
// Enhance specific news item
POST /api/news/:newsId/enhance-image
Body: { force?: boolean }

// Enhance recent news items
POST /api/news/enhance/recent
Body: { 
  hoursBack?: number,    // Default: 24
  batchSize?: number,    // Default: 5
  skipExisting?: boolean // Default: true
}

// Get enhancement statistics
GET /api/news/images/stats

// Test image generation
POST /api/news/images/test
Body: { prompt: string }
```

### Response Format

```typescript
interface ImageResult {
  url: string;
  source: 'unsplash' | 'replicate';
  attribution?: string; // Required for Unsplash
}

interface EnhancementStats {
  total: number;
  withImages: number;
  withoutImages: number;
  unsplashImages: number;
  replicateImages: number;
  enhancementPercentage: number;
}
```

## üß™ Testing

### Run Test Script

```bash
# 1. Set environment variables
export REPLICATE_API_TOKEN=your-replicate-api-token-here

# 2. Start backend server
cd src/backend && npm run dev

# 3. Update JWT token in test script
# 4. Run tests
node test-image-service.js --run
```

### Manual Testing

1. **Create a news agent** and run it
2. **Check news page** - items should have images
3. **Hover over images** to see attribution
4. **Check network tab** - verify API calls

## üí∞ Cost Optimization

### Smart Fallback Strategy

1. **Free Unsplash first** (0 cost, 50 requests/hour)
2. **FLUX generation fallback** (~$0.003 per image)
3. **Intelligent caching** (7-day TTL)

### Expected Costs

- **Unsplash**: Free (up to 50 requests/hour)
- **FLUX via Replicate**: ~$0.003 per generation
- **Monthly estimate**: $5-15 for active usage

### Cache Efficiency

- Images cached for 7 days
- Prompt-based deduplication
- Automatic cleanup of expired entries

## üîç Monitoring

### Image Enhancement Stats

Track enhancement performance via:
- Total news items vs. enhanced items
- Source breakdown (Unsplash vs. FLUX)
- Enhancement percentage over time
- Failed enhancement tracking

### Logs

Monitor these log patterns:
```
[CrewAIExecutor] üñºÔ∏è Enhanced news item with replicate image
[ImageService] Using cached image for: technology news
[ImageService] Unsplash fetch failed: Rate limit exceeded
```

## üé® Customization

### Prompt Engineering

Modify `generateImagePrompt()` in `newsEnhancementService.ts`:
```typescript
function generateImagePrompt(newsItem: INewsItem): string {
  // Add custom logic for better prompts
  let prompt = newsItem.title;
  
  // Add category context
  if (newsItem.category) {
    prompt = `${newsItem.category} ${prompt}`;
  }
  
  // Your custom enhancements here
  return prompt;
}
```

### FLUX Parameters

Adjust generation settings in `imageService.ts`:
```typescript
const [url] = await replicate.run('black-forest-labs/flux-dev', {
  input: {
    prompt: enhancedPrompt,
    aspect_ratio: '16:9',      // Customize aspect ratio
    guidance: 3,               // Adjust creativity vs. prompt adherence
    num_inference_steps: 34,   // Quality vs. speed tradeoff
    go_fast: true,            // Enable optimizations
    output_format: 'webp',    // File format
    output_quality: 85        // Compression level
  }
});
```

## üö® Troubleshooting

### Common Issues

**"Replicate API token not configured"**
- Set `REPLICATE_API_TOKEN` in `.env`
- Restart backend server

**"Unsplash fetch failed: Rate limit exceeded"**
- Normal behavior, will fallback to FLUX
- Consider getting Unsplash Pro for higher limits

**Images not showing in frontend**
- Check browser console for errors
- Verify CORS settings
- Check image URLs are accessible

**High FLUX costs**
- Enable Unsplash API to reduce FLUX usage
- Adjust cache TTL for longer retention
- Implement rate limiting for batch operations

### Debug Mode

Enable detailed logging:
```bash
DEBUG=image-service node src/backend/src/server.ts
```

## üìà Future Enhancements

### Planned Features

- **Smart prompt enhancement** using AI
- **Image style consistency** across reports
- **User preference learning** for image types
- **Batch processing optimization**
- **Alternative image providers** (Pexels, Pixabay)

### Configuration Options

Future settings panel will include:
- Image generation preferences
- Source priority settings
- Cache duration controls
- Cost limit management

---

## üéâ Success!

Your agent reports now automatically include relevant, high-quality images that enhance readability and engagement. The system is designed to be cost-effective, reliable, and visually appealing.

For questions or issues, check the logs or run the test script to verify functionality. 